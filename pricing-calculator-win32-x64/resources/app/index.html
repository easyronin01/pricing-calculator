<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Client Fee Calculator</title>
    <!-- App Icon: Place an 'icon.png' file in your project folder -->
    <link rel="icon" type="image/png" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Added SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Adjusted padding to account for fixed header but allow sticky positioning to work relative to it */
        .main-content {
            padding-top: 20px; 
            padding-bottom: 200px;
        }
        
        /* Add padding to the top of the root to offset the fixed header */
        #root {
            padding-top: 64px;
        }
        @media (min-width: 768px) {
            #root {
                padding-top: 80px;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const CATEGORIES = [
            "Office Expenses",
            "Rent & Occupancy",
            "Tools & Software",
            "Government Payments"
        ];

        const Icon = ({ name, className = "w-4 h-4" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({
                        attrs: { class: className },
                        nameAttr: 'data-lucide',
                        root: containerRef.current
                    });
                }
            }, [name, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center"></span>;
        };

        const SmartInput = ({ value, onChange, onBlur, className, placeholder, inputMode, readOnly, disabled }) => {
            const inputRef = useRef(null);
            const [cursor, setCursor] = useState(null);

            const formatForDisplay = (val) => {
                if (val === undefined || val === null || val === "") return "";
                const parts = val.toString().split(".");
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return parts.join(".");
            };

            const handleChange = (e) => {
                const el = e.target;
                const originalValue = el.value;
                const rawValue = originalValue.replace(/,/g, "");
                
                if (rawValue !== "" && !/^\d*\.?\d{0,2}$/.test(rawValue)) {
                    return;
                }

                const selectionEnd = el.selectionEnd;
                setCursor({
                    pos: selectionEnd,
                    length: originalValue.length
                });

                onChange(rawValue);
            };

            useEffect(() => {
                if (inputRef.current && cursor !== null) {
                    const el = inputRef.current;
                    const newLength = el.value.length;
                    const lengthDiff = newLength - cursor.length;
                    const newPos = Math.max(0, cursor.pos + lengthDiff);
                    el.setSelectionRange(newPos, newPos);
                    setCursor(null);
                }
            }, [value, cursor]);

            return (
                <input
                    ref={inputRef}
                    type="text"
                    inputMode={inputMode}
                    value={formatForDisplay(value)}
                    onChange={handleChange}
                    onBlur={onBlur}
                    className={className}
                    placeholder={placeholder}
                    readOnly={readOnly}
                    disabled={disabled}
                />
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('calculator'); // 'calculator' or 'overhead'
            const [isDarkMode, setIsDarkMode] = useState(true);
            const [numberOfSeats, setNumberOfSeats] = useState(1);
            const [exchangeRate, setExchangeRate] = useState(57);
            const [showCurrencyConverter, setShowCurrencyConverter] = useState(false);
            const [usdInput, setUsdInput] = useState("");
            const [phpInput, setPhpInput] = useState("");
            const [globalOverhead, setGlobalOverhead] = useState("");
            const [globalOverheadPhp, setGlobalOverheadPhp] = useState("");
            const [overheadItems, setOverheadItems] = useState([]);
            const [isTemplateEnabled, setIsTemplateEnabled] = useState(false);
            const [clientFilter, setClientFilter] = useState("All");
            const [isFilterDropdownOpen, setIsFilterDropdownOpen] = useState(false);
            
            // Network & Rate States
            const [onlineRate, setOnlineRate] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [rateError, setRateError] = useState(false);
            
            const filterRef = useRef(null);
            
            const [seats, setSeats] = useState([
                { 
                    id: 1, 
                    name: "Seat 1", 
                    clientName: "",
                    salary: "0", 
                    salaryPhp: "0.00",
                    overhead: "0", 
                    overheadPhp: "0.00",
                    flatFee: "0", 
                    isLocked: false, 
                    lockedTotalBilling: 0, 
                    growthFields: [] 
                }
            ]);

            useEffect(() => {
                const handleGlobalWheel = (event) => {
                    if (event.target.type === 'number' || document.activeElement.type === 'number') {
                        event.preventDefault();
                    }
                };
                
                const handleClickOutside = (event) => {
                    if (filterRef.current && !filterRef.current.contains(event.target)) {
                        setIsFilterDropdownOpen(false);
                    }
                };

                // Network Status Listeners
                const handleOnline = () => {
                    setIsOnline(true);
                    setRateError(false);
                    fetchRate(); // Retry fetch immediately when back online
                };
                const handleOffline = () => {
                    setIsOnline(false);
                };
                
                document.addEventListener('wheel', handleGlobalWheel, { passive: false });
                document.addEventListener('mousedown', handleClickOutside);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                const fetchRate = () => {
                    if (!navigator.onLine) {
                        setIsOnline(false);
                        return;
                    }

                    fetch('https://open.er-api.com/v6/latest/USD')
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.rates && data.rates.PHP) {
                                setOnlineRate(data.rates.PHP);
                                setRateError(false);
                                setIsOnline(true);
                            } else {
                                throw new Error('Invalid data format');
                            }
                        })
                        .catch(error => {
                            console.error("Error fetching exchange rate:", error);
                            setRateError(true);
                        });
                };

                // Initial fetch
                fetchRate();

                // Auto-refresh every 60 seconds (60000 ms)
                const intervalId = setInterval(fetchRate, 60000);

                return () => {
                    document.removeEventListener('wheel', handleGlobalWheel);
                    document.removeEventListener('mousedown', handleClickOutside);
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                    clearInterval(intervalId);
                };
            }, []);

            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    document.body.classList.add('bg-slate-900', 'text-slate-50');
                    document.body.classList.remove('bg-slate-50', 'text-slate-900');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.body.classList.add('bg-slate-50', 'text-slate-900');
                    document.body.classList.remove('bg-slate-900', 'text-slate-50');
                }
            }, [isDarkMode]);

            // Update main state when exchange rate changes
            useEffect(() => {
                setSeats(previousSeats => previousSeats.map(seat => ({
                    ...seat,
                    salaryPhp: seat.salary ? (parseFloat(seat.salary) * exchangeRate).toFixed(2) : "",
                    overheadPhp: seat.overhead ? (parseFloat(seat.overhead) * exchangeRate).toFixed(2) : ""
                })));
                
                // Recalculate global overhead php if manual
                if (globalOverhead && overheadItems.length === 0) {
                    setGlobalOverheadPhp((parseFloat(globalOverhead) * exchangeRate).toFixed(2));
                }

                // Update overhead items conversions
                setOverheadItems(prevItems => prevItems.map(item => ({
                    ...item,
                    costPhp: item.costUsd ? (parseFloat(item.costUsd) * exchangeRate).toFixed(2) : ""
                })));

            }, [exchangeRate]);

            // Sync Breakdown to Global Overhead
            useEffect(() => {
                if (overheadItems.length > 0) {
                    const totalUsd = overheadItems.reduce((sum, item) => sum + (parseFloat(item.costUsd) || 0), 0);
                    const totalUsdStr = totalUsd.toFixed(2);
                    setGlobalOverhead(totalUsdStr);
                    setGlobalOverheadPhp((totalUsd * exchangeRate).toFixed(2));
                    updateSeatsWithNewOverhead(totalUsdStr);
                }
            }, [overheadItems, exchangeRate]);


            useEffect(() => {
                const number = parseInt(numberOfSeats) || 1;
                const clampedNumber = Math.min(Math.max(number, 1), 20);
                
                setSeats(previousSeats => {
                    let newSeats = [];
                    if (clampedNumber > previousSeats.length) {
                        const template = isTemplateEnabled && previousSeats.length > 0 ? previousSeats[previousSeats.length - 1] : null;
                        
                        const addedSeats = Array.from({ length: clampedNumber - previousSeats.length }, (_, index) => ({
                            id: Date.now() + index,
                            name: `Seat ${previousSeats.length + index + 1}`,
                            clientName: "",
                            salary: template ? template.salary : "0",
                            salaryPhp: template ? template.salaryPhp : "0.00",
                            overhead: template ? template.overhead : "0",
                            overheadPhp: template ? template.overheadPhp : "0.00",
                            flatFee: template ? template.flatFee : "0",
                            isLocked: false, 
                            lockedTotalBilling: 0,
                            growthFields: []
                        }));
                        newSeats = [...previousSeats, ...addedSeats];
                    } else if (clampedNumber < previousSeats.length) {
                        newSeats = previousSeats.slice(0, clampedNumber);
                    } else {
                        newSeats = [...previousSeats];
                    }

                    if (globalOverhead && parseFloat(globalOverhead) > 0) {
                        const perSeat = (parseFloat(globalOverhead) / clampedNumber).toFixed(2);
                        return newSeats.map(seat => {
                            const updated = { ...seat, overhead: perSeat };
                            updated.overheadPhp = (parseFloat(perSeat) * exchangeRate).toFixed(2);
                            if (updated.isLocked && updated.growthFields.includes('overhead')) {
                                const s = parseFloat(updated.salary) || 0;
                                const o = parseFloat(perSeat) || 0;
                                const f = parseFloat(updated.flatFee) || 0;
                                updated.lockedTotalBilling = s + o + f;
                            }
                            return updated;
                        });
                    }
                    return newSeats;
                });
            }, [numberOfSeats]);

            const updateSeatsWithNewOverhead = (totalOverheadUsd) => {
                const count = parseInt(numberOfSeats) || 1;
                const numericTotal = parseFloat(totalOverheadUsd) || 0;
                const perSeat = (numericTotal / count).toFixed(2);

                setSeats(previousSeats => previousSeats.map(seat => {
                    const updated = { ...seat, overhead: perSeat };
                    updated.overheadPhp = (parseFloat(perSeat) * exchangeRate).toFixed(2);
                    if (seat.isLocked && seat.growthFields.includes('overhead')) {
                        const s = parseFloat(updated.salary) || 0;
                        const o = parseFloat(perSeat) || 0;
                        const f = parseFloat(updated.flatFee) || 0;
                        updated.lockedTotalBilling = s + o + f;
                    }
                    return updated;
                }));
            };

            const handleGlobalOverheadChange = (rawValue) => {
                setGlobalOverhead(rawValue);
                setGlobalOverheadPhp(rawValue ? (parseFloat(rawValue) * exchangeRate).toFixed(2) : "");
                updateSeatsWithNewOverhead(rawValue);
            };

            const handleGlobalOverheadPhpChange = (rawValue) => {
                setGlobalOverheadPhp(rawValue);
                const usdValue = rawValue ? (parseFloat(rawValue) / exchangeRate).toFixed(2) : "";
                setGlobalOverhead(usdValue);
                updateSeatsWithNewOverhead(usdValue);
            };

            // Overhead Breakdown Logic
            const addOverheadItem = () => {
                setOverheadItems([...overheadItems, { id: Date.now(), category: "", name: "", costUsd: "", costPhp: "" }]);
            };

            const removeOverheadItem = (id) => {
                setOverheadItems(overheadItems.filter(item => item.id !== id));
            };

            const updateOverheadItem = (id, field, value) => {
                setOverheadItems(prev => prev.map(item => {
                    if (item.id === id) {
                        const updated = { ...item, [field]: value };
                        if (field === 'costUsd') {
                            updated.costPhp = value ? (parseFloat(value) * exchangeRate).toFixed(2) : "";
                        } else if (field === 'costPhp') {
                            updated.costUsd = value ? (parseFloat(value) / exchangeRate).toFixed(2) : "";
                        }
                        return updated;
                    }
                    return item;
                }));
            };

            // Seat Logic
            const resetSeat = (id) => {
                setSeats(prev => prev.map(seat => {
                    if (seat.id === id) {
                        const index = prev.findIndex(s => s.id === id);
                        return {
                            ...seat,
                            name: `Seat ${index + 1}`,
                            clientName: "",
                            salary: "0",
                            salaryPhp: "0.00",
                            overhead: "0",
                            overheadPhp: "0.00",
                            flatFee: "0",
                            isLocked: false,
                            lockedTotalBilling: 0,
                            growthFields: []
                        };
                    }
                    return seat;
                }));
            };

            const updateSeat = (id, field, rawValue) => {
                setSeats(previousSeats => previousSeats.map(seat => {
                    if (seat.id === id) {
                        const updatedSeat = { ...seat, [field]: rawValue };
                        if (field === 'name' || field === 'clientName') return updatedSeat;

                        if (field === 'salary') {
                            updatedSeat.salaryPhp = rawValue ? (parseFloat(rawValue) * exchangeRate).toFixed(2) : "";
                        } else if (field === 'salaryPhp') {
                            updatedSeat.salary = rawValue ? (parseFloat(rawValue) / exchangeRate).toFixed(2) : "";
                        } else if (field === 'overhead') {
                            updatedSeat.overheadPhp = rawValue ? (parseFloat(rawValue) * exchangeRate).toFixed(2) : "";
                        } else if (field === 'overheadPhp') {
                            updatedSeat.overhead = rawValue ? (parseFloat(rawValue) / exchangeRate).toFixed(2) : "";
                        }

                        const baseField = field.endsWith('Php') ? field.replace('Php', '') : field;
                        if (seat.isLocked && seat.growthFields.includes(baseField)) {
                            const s = parseFloat(updatedSeat.salary) || 0;
                            const o = parseFloat(updatedSeat.overhead) || 0;
                            const f = parseFloat(updatedSeat.flatFee) || 0;
                            updatedSeat.lockedTotalBilling = s + o + f;
                        }
                        return updatedSeat;
                    }
                    return seat;
                }));
            };

            const finalizeFieldSetup = (id, field) => {
                const baseField = field.endsWith('Php') ? field.replace('Php', '') : field;
                setSeats(previousSeats => previousSeats.map(seat => {
                    if (seat.id === id && seat.isLocked && seat.growthFields.includes(baseField)) {
                        const val = parseFloat(seat[baseField]) || 0;
                        if (val > 0) return { ...seat, growthFields: seat.growthFields.filter(f => f !== baseField) };
                    }
                    return seat;
                }));
            };

            const toggleLock = (id) => {
                setSeats(previousSeats => previousSeats.map(seat => {
                    if (seat.id === id) {
                        const salaryValue = parseFloat(seat.salary) || 0;
                        const overheadValue = parseFloat(seat.overhead) || 0;
                        const flatFeeValue = parseFloat(seat.flatFee) || 0;
                        const currentTotal = salaryValue + overheadValue + flatFeeValue;
                        const activeGrowth = [];
                        if (!seat.isLocked) {
                            if (salaryValue === 0) activeGrowth.push('salary');
                            if (overheadValue === 0) activeGrowth.push('overhead');
                        }
                        return { ...seat, isLocked: !seat.isLocked, lockedTotalBilling: !seat.isLocked ? currentTotal : 0, growthFields: activeGrowth };
                    }
                    return seat;
                }));
            };

            const getSeatMetrics = (seat) => {
                const numberSalary = parseFloat(seat.salary) || 0;
                const numberOverhead = parseFloat(seat.overhead) || 0;
                const numberFlatFee = parseFloat(seat.flatFee) || 0;
                const clientFee = seat.isLocked ? seat.lockedTotalBilling : (numberSalary + numberOverhead + numberFlatFee);
                const profit = clientFee - (numberSalary + numberOverhead);
                const profitMargin = clientFee > 0 ? ((profit / clientFee) * 100) : 0;
                const hourlyRate = (clientFee / 22) / 8;
                const phpCharge = clientFee * exchangeRate;
                return { clientFee, profit, profitMargin, hourlyRate, phpCharge };
            };

            const uniqueClients = useMemo(() => {
                const names = seats.map(s => s.clientName).filter(n => n && n.trim() !== "");
                return ["All", ...new Set(names)];
            }, [seats]);

            const filteredSeats = useMemo(() => {
                if (clientFilter === "All") return seats;
                return seats.filter(s => s.clientName === clientFilter);
            }, [seats, clientFilter]);

            const totals = useMemo(() => {
                return filteredSeats.reduce((accumulator, seat) => {
                    const metrics = getSeatMetrics(seat);
                    accumulator.totalCharge += metrics.clientFee;
                    accumulator.totalProfit += metrics.profit;
                    accumulator.totalSalary += (parseFloat(seat.salary) || 0);
                    accumulator.totalPhp += metrics.phpCharge;
                    accumulator.sumMargins += metrics.profitMargin;
                    return accumulator;
                }, { totalCharge: 0, totalProfit: 0, totalSalary: 0, totalPhp: 0, sumMargins: 0 });
            }, [filteredSeats, exchangeRate]);

            const averageProfitMargin = filteredSeats.length > 0 ? totals.sumMargins / filteredSeats.length : 0;

            const handleUsdToPhp = (raw) => {
                setUsdInput(raw);
                setPhpInput(raw ? (parseFloat(raw) * exchangeRate).toFixed(2) : "");
            };

            const handlePhpToUsd = (raw) => {
                setPhpInput(raw);
                setUsdInput(raw ? (parseFloat(raw) / exchangeRate).toFixed(2) : "");
            };

            const resetAll = () => {
                setNumberOfSeats(1);
                setGlobalOverhead("");
                setGlobalOverheadPhp("");
                setOverheadItems([]);
                setIsTemplateEnabled(false);
                setClientFilter("All");
                setSeats([{ id: Date.now(), name: "Seat 1", clientName: "", salary: "0", salaryPhp: "0.00", overhead: "0", overheadPhp: "0.00", flatFee: "0", isLocked: false, lockedTotalBilling: 0, growthFields: [] }]);
            };

            const formatCurrency = (amount) => amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const handleSeatCountChange = (value) => {
                const stripped = value.replace(/\D/g, "");
                const numeric = parseInt(stripped);
                if (stripped === "") setNumberOfSeats("");
                else if (!isNaN(numeric)) setNumberOfSeats(Math.min(20, numeric));
            };

            const handleSeatCountBlur = () => {
                const numeric = parseInt(numberOfSeats);
                if (isNaN(numeric) || numeric < 1) setNumberOfSeats(1);
            };

            const getDisplayFilterName = () => {
                if (clientFilter === "All") return "ALL CLIENTS";
                return clientFilter.split(' ')[0].toUpperCase();
            };

            // Excel Report Generation
            const handleGenerateReport = () => {
                if (!window.XLSX) {
                    alert("Export functionality unavailable. Please check internet connection to load libraries.");
                    return;
                }

                const wb = XLSX.utils.book_new();
                const dateStr = new Date().toLocaleDateString().replace(/\//g, "-");

                // --- SHEET 1: SUMMARY ---
                const summaryData = [
                    ["CLIENT FEE CALCULATOR - SUMMARY REPORT"],
                    ["Generated on:", new Date().toLocaleString()],
                    [],
                    ["GLOBAL SETTINGS"],
                    ["Base Exchange Rate", `1 USD = ${exchangeRate} PHP`],
                    ["Total Active Units", seats.length],
                    [],
                    ["FINANCIAL OVERVIEW (MONTHLY)"],
                    ["Total Revenue (Client Fee)", `$${formatCurrency(totals.totalCharge)}`],
                    ["Total Cost (Salary)", `$${formatCurrency(totals.totalSalary)}`],
                    ["Total Profit", `$${formatCurrency(totals.totalProfit)}`],
                    ["Average Profit Margin", `${averageProfitMargin.toFixed(2)}%`],
                    ["Total PHP Volume", `₱${formatCurrency(totals.totalPhp)}`]
                ];
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                
                // Style columns width
                wsSummary['!cols'] = [{ wch: 30 }, { wch: 25 }];
                XLSX.utils.book_append_sheet(wb, wsSummary, "Dashboard Summary");

                // --- SHEET 2: OPERATIONAL UNITS ---
                const seatHeaders = [
                    "Seat ID", 
                    "Employee Name", 
                    "Client Name", 
                    "Salary (USD)", 
                    "Salary (PHP)", 
                    "Overhead (USD)", 
                    "Overhead (PHP)", 
                    "Mgmt Fee (USD)", 
                    "Mgmt Fee (PHP)", 
                    "Total Client Fee (USD)", 
                    "Total Client Fee (PHP)", 
                    "Profit (USD)", 
                    "Margin (%)", 
                    "Hourly Rate (USD)"
                ];
                
                const seatRows = seats.map((seat, index) => {
                    const m = getSeatMetrics(seat);
                    return [
                        index + 1,
                        seat.name,
                        seat.clientName,
                        parseFloat(seat.salary) || 0,
                        parseFloat(seat.salaryPhp) || 0,
                        parseFloat(seat.overhead) || 0,
                        parseFloat(seat.overheadPhp) || 0,
                        parseFloat(seat.flatFee) || 0,
                        (parseFloat(seat.flatFee) || 0) * exchangeRate,
                        m.clientFee,
                        m.phpCharge,
                        m.profit,
                        parseFloat(m.profitMargin.toFixed(2)),
                        parseFloat(m.hourlyRate.toFixed(2))
                    ];
                });

                const wsSeats = XLSX.utils.aoa_to_sheet([seatHeaders, ...seatRows]);
                wsSeats['!cols'] = seatHeaders.map(() => ({ wch: 18 })); // Set default column width
                XLSX.utils.book_append_sheet(wb, wsSeats, "Operational Units");

                // --- SHEET 3: OVERHEAD BREAKDOWN ---
                if (overheadItems.length > 0) {
                    const overheadHeaders = ["Category", "Description", "Cost (USD)", "Cost (PHP)"];
                    const overheadRows = overheadItems.map(item => [
                        item.category,
                        item.name,
                        parseFloat(item.costUsd) || 0,
                        parseFloat(item.costPhp) || 0
                    ]);
                    // Add Total Row
                    overheadRows.push([]);
                    overheadRows.push(["TOTAL OVERHEAD", "", parseFloat(globalOverhead) || 0, parseFloat(globalOverheadPhp) || 0]);

                    const wsOverhead = XLSX.utils.aoa_to_sheet([overheadHeaders, ...overheadRows]);
                    wsOverhead['!cols'] = [{ wch: 20 }, { wch: 40 }, { wch: 15 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, wsOverhead, "Overhead Breakdown");
                }

                // Export
                XLSX.writeFile(wb, `Client_Fee_Report_${dateStr}.xlsx`);
            };

            return (
                <div className="min-h-screen transition-colors duration-300">
                    <header className={`fixed top-0 left-0 right-0 z-50 border-b backdrop-blur-md ${isDarkMode ? 'bg-slate-900/80 border-slate-800' : 'bg-white/80 border-slate-200'}`}>
                        <div className="max-w-7xl mx-auto px-4 h-16 md:h-20 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="p-1.5 bg-blue-600 rounded-lg shadow-lg shadow-blue-500/20">
                                    <Icon name="trending-up" className="w-5 h-5 text-white" />
                                </div>
                                <div className="hidden sm:block">
                                    <h1 className="text-lg md:text-xl font-black tracking-tight text-slate-900 dark:text-slate-50">Client Fee Calculator</h1>
                                    <p className={`text-[9px] uppercase font-bold tracking-widest ${isDarkMode ? 'text-slate-500' : 'text-slate-400'}`}>Sustainable Profit Protection</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowCurrencyConverter(!showCurrencyConverter)} className={`p-2 rounded-lg transition-all ${isDarkMode ? 'bg-slate-800 hover:bg-slate-700' : 'bg-slate-100 hover:bg-slate-200'}`} title="Currency Converter"><Icon name="languages" className="w-4 h-4" /></button>
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 rounded-lg transition-all ${isDarkMode ? 'bg-slate-800 hover:bg-slate-700' : 'bg-slate-100 hover:bg-slate-200'}`}><Icon name={isDarkMode ? "sun" : "moon" } className="w-4 h-4" /></button>
                                <button onClick={resetAll} className="hidden md:flex items-center gap-2 px-3 py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg transition-all text-xs"><Icon name="rotate-ccw" className="w-3.5 h-3.5" /> Reset All</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 main-content">
                        {/* STICKY DASHBOARD SECTION */}
                        <div className={`sticky top-16 md:top-20 z-40 pb-6 pt-4 -mx-4 px-4 border-b transition-colors duration-300 ${isDarkMode ? 'bg-slate-900/95 border-slate-800' : 'bg-slate-50/95 border-slate-200'} backdrop-blur-sm`}>
                            
                            {/* Controls Row: Tabs (Left) + Operational Controls (Right) */}
                            <div className="flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
                                {/* Tab Navigation - Left */}
                                <div className={`p-1 rounded-xl flex gap-1 ${isDarkMode ? 'bg-slate-800 border border-slate-700' : 'bg-slate-100 border border-slate-200'}`}>
                                    <button onClick={() => setActiveTab('calculator')} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'calculator' ? 'bg-blue-600 text-white shadow-md' : (isDarkMode ? 'text-slate-400 hover:text-white' : 'text-slate-500 hover:text-slate-900')}`}>
                                        Calculator
                                    </button>
                                    <button onClick={() => setActiveTab('overhead')} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'overhead' ? 'bg-blue-600 text-white shadow-md' : (isDarkMode ? 'text-slate-400 hover:text-white' : 'text-slate-500 hover:text-slate-900')}`}>
                                        Overhead Breakdown
                                    </button>
                                </div>

                                {/* Operational Controls - Right (Moved from body) */}
                                <div className="flex flex-col items-end gap-1 w-full md:w-auto">
                                    <div className="flex flex-wrap justify-end items-center gap-2 w-full">
                                        <div className="relative w-36 md:w-44" ref={filterRef}>
                                            <button onClick={() => setIsFilterDropdownOpen(!isFilterDropdownOpen)} className={`w-full h-9 pl-9 pr-10 rounded-xl border text-[10px] font-black flex items-center transition-all cursor-pointer uppercase tracking-widest truncate ${isDarkMode ? 'bg-slate-800 border-slate-700 text-slate-300 hover:bg-slate-700' : 'bg-white border-slate-200 text-slate-600 shadow-sm hover:bg-slate-50'}`}><span className="truncate">{getDisplayFilterName()}</span></button>
                                            <div className="absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400"><Icon name="filter" className="w-3.5 h-3.5" /></div>
                                            <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400"><Icon name="chevron-down" className="w-3 h-3" /></div>
                                            {isFilterDropdownOpen && (
                                                <div className={`absolute top-full left-0 w-full mt-2 rounded-xl border shadow-xl z-[60] py-2 overflow-hidden overflow-y-auto max-h-48 custom-scrollbar ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                                    {uniqueClients.map(client => (
                                                        <button key={client} onClick={() => { setClientFilter(client); setIsFilterDropdownOpen(false); }} className={`w-full text-left px-4 py-2 text-[10px] font-black uppercase tracking-widest transition-colors ${isDarkMode ? 'hover:bg-slate-700 text-slate-300' : 'hover:bg-slate-50 text-slate-600'} ${clientFilter === client ? 'text-blue-500' : ''}`}>{client === "All" ? "ALL CLIENTS" : client}</button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        <button onClick={() => setIsTemplateEnabled(!isTemplateEnabled)} title="Copy template values for new seats" className={`h-9 px-4 rounded-xl flex items-center gap-2 border transition-all text-[10px] font-black uppercase tracking-widest ${isTemplateEnabled ? 'bg-blue-600 border-blue-600 text-white shadow-lg shadow-blue-500/20' : (isDarkMode ? 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50 shadow-sm')}`}><Icon name="layers" className="w-3.5 h-3.5" /><span>Copy Seat</span></button>
                                        <div className="flex items-center">
                                            <button onClick={() => setNumberOfSeats(Math.max(1, (parseInt(numberOfSeats) || 1) - 1))} className={`w-9 h-9 rounded-xl flex items-center justify-center border transition-all rounded-r-none border-r-0 ${isDarkMode ? 'bg-slate-800 border-slate-700 hover:bg-slate-700' : 'bg-white border-slate-200 hover:bg-slate-100 shadow-sm'}`}><Icon name="minus" className="w-4 h-4" /></button>
                                            <input type="text" inputMode="numeric" value={numberOfSeats} onChange={(e) => handleSeatCountChange(e.target.value)} onBlur={handleSeatCountBlur} className={`w-12 h-9 border-y text-center text-base font-black outline-none transition-all focus:z-10 focus:ring-2 focus:ring-blue-500/20 ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200 shadow-inner text-slate-900'}`} />
                                            <button onClick={() => setNumberOfSeats(Math.min(20, (parseInt(numberOfSeats) || 1) + 1))} className={`w-9 h-9 rounded-xl flex items-center justify-center border transition-all rounded-l-none border-l-0 ${isDarkMode ? 'bg-slate-800 border-slate-700 hover:bg-slate-700' : 'bg-white border-slate-200 hover:bg-slate-50 shadow-sm'}`}><Icon name="plus" className="w-4 h-4" /></button>
                                        </div>
                                    </div>
                                    <p className={`text-[9px] font-bold uppercase tracking-widest px-1 mt-0.5 ${isDarkMode ? 'text-slate-50' : 'text-slate-400'}`}>* Showing {filteredSeats.length} of {seats.length} Units</p>
                                </div>
                            </div>

                            {/* Top Stats Grid - Persistent across tabs */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                <div className={`p-4 rounded-2xl border ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200 shadow-sm'}`}>
                                    <div className="flex justify-between items-center mb-1.5">
                                        <label className="block text-[10px] font-black uppercase text-blue-500">Base Exchange Rate</label>
                                        
                                        {/* Status Indicator Logic */}
                                        {(!isOnline || rateError) ? (
                                            <div className="flex items-center gap-1.5" title="Connection lost">
                                                <div className="w-1.5 h-1.5 rounded-full bg-red-500"></div>
                                                <span className="text-[9px] font-bold text-red-500">Exchange rate unavailable: offline</span>
                                            </div>
                                        ) : onlineRate ? (
                                            <div className="flex items-center gap-1.5 animate-pulse" title="Updates every 60 seconds">
                                                <div className="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                                                <span className={`text-[9px] font-bold ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>Live Updates: ₱{onlineRate.toFixed(2)}</span>
                                            </div>
                                        ) : null}
                                    </div>
                                    
                                    <div className="flex items-center gap-2">
                                        <div className="relative flex-1">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 font-bold text-slate-400 text-sm">1 USD :</span>
                                            <SmartInput inputMode="decimal" value={exchangeRate} onChange={(raw) => setExchangeRate(raw || 0)} className={`w-full pl-16 pr-10 py-2 rounded-xl border font-bold text-sm outline-none focus:ring-2 focus:ring-blue-500/20 ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-slate-50 border-slate-200 text-slate-900'}`} />
                                            <span className="absolute right-3 top-1/2 -translate-y-1/2 font-bold text-slate-400 text-sm">PHP</span>
                                        </div>
                                        <div className="flex items-center">
                                            <button 
                                                onClick={() => setExchangeRate(prev => Math.max(0, (parseFloat(prev) || 0) - 1))}
                                                className={`w-9 h-9 flex items-center justify-center rounded-xl rounded-r-none border border-r-0 transition-all ${isDarkMode ? 'bg-slate-900 border-slate-700 hover:bg-slate-700' : 'bg-slate-50 border-slate-200 hover:bg-slate-100'}`}
                                            >
                                                <Icon name="minus" className="w-4 h-4" />
                                            </button>
                                            <button 
                                                onClick={() => setExchangeRate(prev => (parseFloat(prev) || 0) + 1)}
                                                className={`w-9 h-9 flex items-center justify-center rounded-xl rounded-l-none border transition-all ${isDarkMode ? 'bg-slate-900 border-slate-700 hover:bg-slate-700' : 'bg-slate-50 border-slate-200 hover:bg-slate-100'}`}
                                            >
                                                <Icon name="plus" className="w-4 h-4" />
                                            </button>
                                        </div>
                                    </div>
                                    {onlineRate && isOnline && !rateError && (
                                        <button 
                                            onClick={() => setExchangeRate(onlineRate)}
                                            className={`w-full mt-2 py-1 text-[9px] font-bold uppercase tracking-widest rounded-lg border transition-all ${isDarkMode ? 'border-slate-700 text-slate-400 hover:bg-slate-700 hover:text-white' : 'border-slate-200 text-slate-500 hover:bg-slate-100 hover:text-slate-900'}`}
                                        >
                                            Apply Live Rate (₱{onlineRate.toFixed(2)})
                                        </button>
                                    )}
                                </div>
                                <div className={`p-4 rounded-2xl border ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200 shadow-sm'}`}>
                                    <div className="flex items-center justify-between mb-1.5"><label className="text-[10px] font-black uppercase text-indigo-500">Quick Currency Conversion</label><Icon name="repeat" className="w-3 h-3 text-slate-400" /></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 font-bold text-slate-400 text-sm">$</span><SmartInput inputMode="decimal" placeholder="USD" value={usdInput} onChange={handleUsdToPhp} className={`w-full pl-7 pr-3 py-2 rounded-xl border font-bold text-sm outline-none ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-slate-50 border-slate-200'}`} /></div>
                                        <div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 font-bold text-slate-400 text-sm">₱</span><SmartInput inputMode="decimal" placeholder="PHP" value={phpInput} onChange={handlePhpToUsd} className={`w-full pl-7 pr-3 py-2 rounded-xl border font-bold text-sm outline-none ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-slate-50 border-slate-200'}`} /></div>
                                    </div>
                                </div>
                                <div className={`p-4 rounded-2xl border ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200 shadow-sm'}`}>
                                    <div className="flex items-center justify-between mb-1.5">
                                        <label className="text-[10px] font-black uppercase text-indigo-500">Total Overhead Cost</label>
                                        {overheadItems.length > 0 && <span className="text-[9px] font-bold text-blue-500 bg-blue-500/10 px-2 py-0.5 rounded-full">Synced to Breakdown</span>}
                                        <Icon name="split" className="w-3 h-3 text-slate-400" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="relative">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 font-bold text-slate-400 text-sm">$</span>
                                            <SmartInput 
                                                inputMode="decimal" 
                                                placeholder="0.00" 
                                                value={globalOverhead} 
                                                onChange={handleGlobalOverheadChange} 
                                                readOnly={overheadItems.length > 0}
                                                className={`w-full pl-7 pr-3 py-2 rounded-xl border font-bold text-sm outline-none ${overheadItems.length > 0 ? (isDarkMode ? 'bg-slate-900/50 text-slate-500 border-slate-800 cursor-not-allowed' : 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed') : (isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-slate-50 border-slate-200')}`} 
                                            />
                                        </div>
                                        <div className="relative">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 font-bold text-slate-400 text-sm">₱</span>
                                            <SmartInput 
                                                inputMode="decimal" 
                                                placeholder="0.00" 
                                                value={globalOverheadPhp} 
                                                onChange={handleGlobalOverheadPhpChange} 
                                                readOnly={overheadItems.length > 0}
                                                className={`w-full pl-7 pr-3 py-2 rounded-xl border font-bold text-sm outline-none ${overheadItems.length > 0 ? (isDarkMode ? 'bg-slate-900/50 text-slate-500 border-slate-800 cursor-not-allowed' : 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed') : (isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-slate-50 border-slate-200')}`} 
                                            />
                                        </div>
                                    </div>
                                    <p className="text-[8px] font-bold text-slate-400 mt-1 uppercase tracking-tight">* Automatically divides by {numberOfSeats} units</p>
                                </div>
                            </div>
                        </div>

                        <div className="mt-6">
                        {activeTab === 'calculator' ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {filteredSeats.map((seat) => {
                                    const metrics = getSeatMetrics(seat);
                                    return (
                                        <div key={seat.id} className={`group p-4 rounded-2xl border relative transition-all duration-300 ${isDarkMode ? 'bg-slate-800 border-slate-700 hover:border-blue-500/50' : 'bg-white border-slate-200 hover:border-blue-500/50 shadow-sm hover:shadow-md'}`}>
                                            <button onClick={() => resetSeat(seat.id)} title="Reset unit inputs" className="absolute top-4 right-4 text-slate-300 hover:text-red-400 transition-colors"><Icon name="rotate-ccw" className="w-3.5 h-3.5" /></button>
                                            <div className="grid grid-cols-1 gap-2.5 mb-4 pr-6">
                                                <div className="space-y-1"><label className="text-[9px] font-black uppercase tracking-tighter text-slate-400 ml-1">Employee Name</label><input type="text" value={seat.name} placeholder="Name..." onChange={(e) => updateSeat(seat.id, 'name', e.target.value)} className={`w-full px-3 py-1.5 rounded-lg text-sm font-black border-none outline-none focus:ring-2 focus:ring-blue-500/20 transition-all ${isDarkMode ? 'bg-slate-900 text-white placeholder-slate-700' : 'bg-slate-50 text-slate-900 placeholder-slate-300'}`} /></div>
                                                <div className="space-y-1"><label className="text-[9px] font-black uppercase tracking-tighter text-slate-400 ml-1">Client Name</label><input type="text" value={seat.clientName} placeholder="Client..." onChange={(e) => updateSeat(seat.id, 'clientName', e.target.value)} className={`w-full px-3 py-1.5 rounded-lg text-sm font-black border-none outline-none focus:ring-2 focus:ring-blue-500/20 transition-all ${isDarkMode ? 'bg-slate-900 text-white placeholder-slate-700' : 'bg-slate-50 text-slate-900 placeholder-slate-300'}`} /></div>
                                            </div>
                                            <div className="space-y-2.5 mb-5">
                                                <div className="space-y-1"><label className="text-[9px] font-black uppercase tracking-tighter text-slate-400 ml-1">Monthly Salary</label>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div className="relative"><span className="absolute left-2.5 top-1/2 -translate-y-1/2 font-bold text-blue-500 text-[10px]">$</span><SmartInput inputMode="decimal" value={seat.salary} onChange={(raw) => updateSeat(seat.id, 'salary', raw)} onBlur={() => finalizeFieldSetup(seat.id, 'salary')} className={`w-full pl-5 pr-2 py-1.5 rounded-lg border font-bold text-xs outline-none transition-all ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-slate-50 border-slate-200'}`} /></div>
                                                        <div className="relative"><span className="absolute left-2.5 top-1/2 -translate-y-1/2 font-bold text-green-600 text-[10px]">₱</span><SmartInput inputMode="decimal" value={seat.salaryPhp} onChange={(raw) => updateSeat(seat.id, 'salaryPhp', raw)} onBlur={() => finalizeFieldSetup(seat.id, 'salaryPhp')} className={`w-full pl-5 pr-2 py-1.5 rounded-lg border font-bold text-xs outline-none transition-all ${isDarkMode ? 'bg-slate-800 border-slate-700 text-slate-400 placeholder-slate-600' : 'bg-slate-100 border-slate-100 text-slate-500 placeholder-slate-400'}`} /></div>
                                                    </div>
                                                </div>
                                                <div className="space-y-1"><label className="text-[9px] font-black uppercase tracking-tighter text-slate-400 ml-1">Operating Cost Per Seat</label>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div className="relative"><span className="absolute left-2.5 top-1/2 -translate-y-1/2 font-bold text-indigo-500 text-[10px]">$</span><SmartInput inputMode="decimal" value={seat.overhead} onChange={(raw) => updateSeat(seat.id, 'overhead', raw)} onBlur={() => finalizeFieldSetup(seat.id, 'overhead')} className={`w-full pl-5 pr-2 py-1.5 rounded-lg border font-bold text-xs outline-none transition-all ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-slate-50 border-slate-200'}`} /></div>
                                                        <div className="relative"><span className="absolute left-2.5 top-1/2 -translate-y-1/2 font-bold text-green-600 text-[10px]">₱</span><SmartInput inputMode="decimal" value={seat.overheadPhp} onChange={(raw) => updateSeat(seat.id, 'overheadPhp', raw)} onBlur={() => finalizeFieldSetup(seat.id, 'overheadPhp')} className={`w-full pl-5 pr-2 py-1.5 rounded-lg border font-bold text-xs outline-none transition-all ${isDarkMode ? 'bg-slate-800 border-slate-700 text-slate-400 placeholder-slate-600' : 'bg-slate-100 border-slate-100 text-slate-500 placeholder-slate-400'}`} /></div>
                                                    </div>
                                                </div>
                                                <div className="space-y-1"><div className="flex items-center justify-between px-1"><label className="text-[9px] font-black uppercase tracking-tighter text-slate-400">Management Fee</label><button onClick={() => toggleLock(seat.id)} className={`p-0.5 rounded transition-colors ${seat.isLocked ? 'text-blue-500' : 'text-slate-300 hover:text-blue-400'}`}><Icon name={seat.isLocked ? "lock" : "unlock"} className="w-3 h-3" /></button></div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div className="relative"><span className="absolute left-2.5 top-1/2 -translate-y-1/2 font-bold text-purple-500 text-[10px]">$</span><SmartInput inputMode="decimal" value={seat.flatFee} readOnly={seat.isLocked} onChange={(raw) => updateSeat(seat.id, 'flatFee', raw)} className={`w-full pl-5 pr-2 py-1.5 rounded-lg border font-bold text-xs outline-none transition-all ${seat.isLocked ? (isDarkMode ? 'bg-slate-700 border-transparent text-slate-500 italic' : 'bg-slate-100 border-transparent text-slate-400 italic') : (isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-slate-50 border-slate-200')}`} /></div>
                                                        <div className="relative"><span className="absolute left-2.5 top-1/2 -translate-y-1/2 font-bold text-slate-400 text-[10px]">₱</span><div className={`w-full pl-5 pr-2 py-1.5 rounded-lg border font-bold text-xs truncate flex items-center ${isDarkMode ? 'bg-slate-800/50 border-slate-700/50 text-slate-400' : 'bg-slate-100/50 border-slate-100 text-slate-400'}`}>{formatCurrency(parseFloat(seat.flatFee || 0) * exchangeRate)}</div></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className={`p-3.5 rounded-xl ${isDarkMode ? 'bg-slate-900/50' : 'bg-slate-50'}`}>
                                                <div className="flex justify-between items-start mb-3"><div className="space-y-0.5"><div className="text-[9px] font-black uppercase text-slate-400">Client Fee</div><div className={`text-xl font-black ${seat.isLocked ? (isDarkMode ? 'text-blue-400/70 italic' : 'text-blue-500/70 italic') : 'text-blue-600'}`}>${formatCurrency(metrics.clientFee)}</div><div className="text-[8px] font-bold text-slate-400 leading-none">₱{formatCurrency(metrics.phpCharge)}</div></div><div className="text-right space-y-0.5"><div className="text-[9px] font-black uppercase text-slate-400">Margin</div><div className={`text-base font-black ${metrics.profitMargin >= 30 ? 'text-green-500' : metrics.profitMargin >= 20 ? 'text-yellow-500' : 'text-red-500'}`}>{metrics.profitMargin.toFixed(1)}%</div></div></div>
                                                <div className="grid grid-cols-2 gap-2 pt-2.5 border-t border-slate-200 dark:border-slate-800"><div className="space-y-0.5"><div className="text-[8px] font-black uppercase text-slate-400 leading-none">Monthly Profit</div><div className={`text-xs font-bold ${metrics.profit < 0 ? 'text-red-500' : 'text-green-500'}`}>${formatCurrency(metrics.profit)}</div></div><div className="text-right space-y-0.5"><div className="text-[8px] font-black uppercase text-slate-400 leading-none">Client Hourly</div><div className={`text-xs font-bold ${isDarkMode ? 'text-slate-300' : 'text-slate-900'}`}>${formatCurrency(metrics.hourlyRate)}</div></div></div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="max-w-4xl mx-auto">
                                <div className={`p-6 rounded-2xl border ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200 shadow-sm'}`}>
                                    <div className="flex items-center justify-between mb-6">
                                        <div>
                                            <h2 className={`text-lg font-black ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Overhead Cost Breakdown</h2>
                                            <p className={`text-xs ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>Itemize expenses to calculate the total global overhead.</p>
                                        </div>
                                        <button onClick={addOverheadItem} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold rounded-xl shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                                            <Icon name="plus" className="w-4 h-4" /> Add Expense Item
                                        </button>
                                    </div>

                                    {overheadItems.length === 0 ? (
                                        <div className={`text-center py-12 border-2 border-dashed rounded-xl ${isDarkMode ? 'border-slate-700 text-slate-500' : 'border-slate-200 text-slate-400'}`}>
                                            <Icon name="list" className="w-8 h-8 mx-auto mb-2 opacity-50" />
                                            <p className="text-sm font-bold">No items added yet</p>
                                            <p className="text-xs mt-1">Add items to automatically calculate the total overhead.</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {overheadItems.map((item, index) => (
                                                <div key={item.id} className={`flex flex-col md:flex-row items-center gap-3 p-3 rounded-xl border ${isDarkMode ? 'bg-slate-900/50 border-slate-700' : 'bg-slate-50 border-slate-200'}`}>
                                                    <div className="w-full md:w-40">
                                                        <label className="text-[9px] font-black uppercase text-slate-400 ml-1">Category</label>
                                                        <div className="relative">
                                                            <select
                                                                value={item.category}
                                                                onChange={(e) => updateOverheadItem(item.id, 'category', e.target.value)}
                                                                className={`w-full pl-3 pr-8 py-1.5 rounded-lg text-sm font-bold border-none outline-none focus:ring-2 focus:ring-blue-500/20 transition-all appearance-none cursor-pointer ${isDarkMode ? 'bg-slate-800' : 'bg-white'} ${item.category === "" ? (isDarkMode ? 'text-slate-500' : 'text-slate-400') : (isDarkMode ? 'text-white' : 'text-slate-900')}`}
                                                            >
                                                                <option value="" disabled>Category</option>
                                                                {CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                                            </select>
                                                            <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                                                <Icon name="chevron-down" className="w-3 h-3" />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="flex-1 w-full md:w-auto">
                                                        <label className="text-[9px] font-black uppercase text-slate-400 ml-1">Description</label>
                                                        <input 
                                                            type="text" 
                                                            value={item.name} 
                                                            onChange={(e) => updateOverheadItem(item.id, 'name', e.target.value)}
                                                            placeholder="Details (e.g. Fiber Internet 500mbps)" 
                                                            className={`w-full px-3 py-1.5 rounded-lg text-sm font-bold border-none outline-none focus:ring-2 focus:ring-blue-500/20 transition-all ${isDarkMode ? 'bg-slate-800 text-white placeholder-slate-600' : 'bg-white text-slate-900 placeholder-slate-400'}`} 
                                                        />
                                                    </div>
                                                    <div className="flex w-full md:w-auto gap-3">
                                                        <div className="w-1/2 md:w-32">
                                                            <label className="text-[9px] font-black uppercase text-blue-500 ml-1">Cost (USD)</label>
                                                            <div className="relative">
                                                                <span className="absolute left-2.5 top-1/2 -translate-y-1/2 font-bold text-slate-400 text-xs">$</span>
                                                                <SmartInput 
                                                                    inputMode="decimal" 
                                                                    value={item.costUsd} 
                                                                    onChange={(val) => updateOverheadItem(item.id, 'costUsd', val)} 
                                                                    className={`w-full pl-6 pr-3 py-1.5 rounded-lg text-sm font-bold outline-none border ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-200 text-slate-900'}`} 
                                                                />
                                                            </div>
                                                        </div>
                                                        <div className="w-1/2 md:w-32">
                                                            <label className="text-[9px] font-black uppercase text-green-600 ml-1">Cost (PHP)</label>
                                                            <div className="relative">
                                                                <span className="absolute left-2.5 top-1/2 -translate-y-1/2 font-bold text-slate-400 text-xs">₱</span>
                                                                <SmartInput 
                                                                    inputMode="decimal" 
                                                                    value={item.costPhp} 
                                                                    onChange={(val) => updateOverheadItem(item.id, 'costPhp', val)} 
                                                                    className={`w-full pl-6 pr-3 py-1.5 rounded-lg text-sm font-bold outline-none border ${isDarkMode ? 'bg-slate-800 border-slate-700 text-slate-400' : 'bg-white border-slate-200 text-slate-500'}`} 
                                                                />
                                                            </div>
                                                        </div>
                                                        <div className="pt-4">
                                                            <button onClick={() => removeOverheadItem(item.id)} className="p-2 text-slate-400 hover:text-red-500 transition-colors">
                                                                <Icon name="trash-2" className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            <div className={`mt-6 p-4 rounded-xl flex justify-between items-center ${isDarkMode ? 'bg-blue-900/20 border border-blue-500/20' : 'bg-blue-50 border border-blue-100'}`}>
                                                <div className="text-sm font-bold text-blue-500">Total Overhead Breakdown</div>
                                                <div className="text-right">
                                                    <div className={`text-xl font-black ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>${formatCurrency(parseFloat(globalOverhead) || 0)}</div>
                                                    <div className="text-xs font-bold text-slate-400">₱{formatCurrency(parseFloat(globalOverheadPhp) || 0)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        </div>
                    </main>

                    <footer className={`fixed bottom-0 left-0 right-0 z-50 border-t ${isDarkMode ? 'bg-slate-900/95 border-slate-800' : 'bg-white/95 border-slate-200 shadow-[0_-5px_15px_rgba(0,0,0,0.03)]'}`}>
                        <div className="max-w-7xl mx-auto px-4 py-4 md:py-6">
                            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-2 items-center">
                                <div className="space-y-0.5"><div className="flex items-center gap-1.5 text-[9px] font-black uppercase tracking-widest text-purple-500 leading-none"><Icon name="users" className="w-2.5 h-2.5" /> Total Salary Cost</div><div className="text-xl md:text-2xl font-black text-purple-500">${formatCurrency(totals.totalSalary)}</div><div className="text-[9px] font-bold text-slate-400 leading-tight">₱ {formatCurrency(totals.totalSalary * exchangeRate)} PHP</div></div>
                                <div className="space-y-0.5"><div className="flex items-center gap-1.5 text-[9px] font-black uppercase tracking-widest text-green-500 leading-none"><Icon name="pie-chart" className="w-2.5 h-2.5" /> Total Profit</div><div className={`text-xl md:text-2xl font-black ${totals.totalProfit >= 0 ? 'text-green-500' : 'text-red-500'}`}>${formatCurrency(totals.totalProfit)}</div><div className="flex items-center gap-1 leading-none"><div className={`w-1.5 h-1.5 rounded-full ${averageProfitMargin >= 30 ? 'bg-green-500' : averageProfitMargin >= 20 ? 'bg-yellow-500' : 'bg-red-500'}`}></div><span className="text-[9px] font-bold text-slate-400 leading-none">{averageProfitMargin.toFixed(1)}% Average</span></div></div>
                                <div className="space-y-0.5"><div className="flex items-center gap-1.5 text-[9px] font-black uppercase tracking-widest text-blue-500 leading-none"><Icon name="credit-card" className="w-2.5 h-2.5" /> Total Client Fee</div><div className="text-xl md:text-2xl font-black text-blue-500">${formatCurrency(totals.totalCharge)}</div><div className={`text-[9px] font-bold ${isDarkMode ? 'text-slate-500' : 'text-slate-400'} leading-none`}>₱{formatCurrency(totals.totalPhp)} PHP</div></div>
                                <div className="flex justify-end col-span-2 lg:col-span-1"><button onClick={handleGenerateReport} className="w-full md:w-auto px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-[10px] font-black rounded-xl shadow-lg shadow-blue-500/10 transition-all hover:-translate-y-0.5">GENERATE REPORT</button></div>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>